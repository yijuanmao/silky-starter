# ğŸš€ Silky Starterï¼šå¦‚ä¸èˆ¬é¡ºæ»‘çš„ Spring Boot ç»„ä»¶ç”Ÿæ€

<div align="center">

[![ä½“éªŒ-ä¸æ»‘ä¸€èˆ¬é¡ºæ»‘](https://img.shields.io/badge/ä½“éªŒ-ä¸æ»‘ä¸€èˆ¬é¡ºæ»‘-ff69b4.svg)]()
[![ç‰¹æ€§-å¼€ç®±å³ç”¨](https://img.shields.io/badge/ç‰¹æ€§-å¼€ç®±å³ç”¨-green.svg)]()
[![ç›®æ ‡-é«˜æ•ˆå¼€å‘](https://img.shields.io/badge/ç›®æ ‡-é«˜æ•ˆå¼€å‘-blue.svg)]()


</div>

<div align="center">

[![Java 1.8+](https://img.shields.io/badge/Java-1.8+-orange.svg)]()
[![Spring Boot 2.7.x](https://img.shields.io/badge/Spring%20Boot-2.7.x-brightgreen.svg)]()
[![Maven 3.10+](https://img.shields.io/badge/Maven-3.10+-blue.svg)]()
[![License Apache 2.0](https://img.shields.io/badge/License-Apache%202.0-lightgrey.svg)]()

</div>

## ğŸŒŸ ç”Ÿæ€å®£è¨€ï¼šå‘Šåˆ«ç¢ç‰‡åŒ–ï¼Œæ‹¥æŠ±å®Œæ•´è§£å†³æ–¹æ¡ˆ

> **Silky ä¸ä»…ä»…æ˜¯ä¸€ç»„ç»„ä»¶ï¼Œè€Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„å¼€å‘ç”Ÿæ€ç³»ç»Ÿï¼**  
> ä»æ•°æ®å­˜å‚¨åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»ç¼“å­˜ç®¡ç†åˆ°æ–‡ä»¶å­˜å‚¨ï¼ŒSilky æä¾›äº†ä¸€ç«™å¼çš„ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆã€‚  
> è®©å¼€å‘è€…å‘Šåˆ«"æ‹¼å›¾å¼"çš„æŠ€æœ¯é€‰å‹ï¼Œä¸“æ³¨äºä¸šåŠ¡åˆ›æ–°ï¼Œäº«å—å¦‚ä¸èˆ¬é¡ºæ»‘çš„å¼€å‘ä½“éªŒï¼

## ğŸ—ï¸ ç”Ÿæ€å…¨æ™¯å›¾

| ç»„ä»¶æ¨¡å—            | å›¾æ ‡  | æ ¸å¿ƒä»·å€¼           | çŠ¶æ€    |
| --------------- | --- | -------------- | ----- |
| **ğŸ”„ çŠ¶æ€ç®¡ç†**     | ğŸ¯  | å¤æ‚ä¸šåŠ¡çŠ¶æ€æµè½¬å¦‚ä¸èˆ¬é¡ºæ»‘  | âœ… å·²å‘å¸ƒ |
| **ğŸ° æ¶ˆæ¯é˜Ÿåˆ—**     | ğŸ“¤  | ä¼ä¸šçº§æ¶ˆæ¯å¤„ç†ï¼Œæ”¯æŒå»¶è¿Ÿæ¶ˆæ¯ | âœ… å·²å‘å¸ƒ |
| **ğŸ’¾ ç¼“å­˜å…¨èƒ½**     | âš¡   | ä¸€ç«™å¼Redisè§£å†³æ–¹æ¡ˆ   | âœ… å·²å‘å¸ƒ |
| **ğŸ“Š NoSQLæ•°æ®åº“** | ğŸƒ  | æç®€MongoDBæ“ä½œ    | âœ… å·²å‘å¸ƒ |
| **â˜ï¸ äº‘å­˜å‚¨**      | ğŸ—‚ï¸ | å¤šäº‘ç»Ÿä¸€æ–‡ä»¶ç®¡ç†       | âœ… å·²å‘å¸ƒ |
| **ğŸ”§ æ ¸å¿ƒå·¥å…·**     | âš™ï¸  | å…¬å…±åŸºç¡€è®¾æ–½         | âœ… å·²å‘å¸ƒ |

* * *

## ğŸ¯ ç”Ÿæ€ç»„ä»¶æ·±åº¦è§£æ

### 1. ğŸš€ Silky StateMachineï¼šé‡æ–°å®šä¹‰Spring BootçŠ¶æ€ç®¡ç†

**è®©å¤æ‚ä¸šåŠ¡æµè½¬å¦‚ä¸èˆ¬é¡ºæ»‘ï¼**

#### âœ¨ æ ¸å¿ƒç‰¹æ€§

-   **å£°æ˜å¼é…ç½®**ï¼šå‘Šåˆ«if-elseé¢æ¡ä»£ç 
-   **å®ˆå«æ¡ä»¶**ï¼šä¸šåŠ¡è§„åˆ™çš„æ™ºèƒ½å®ˆæŠ¤è€…
-   **è½¬æ¢åŠ¨ä½œ**ï¼šä¸šåŠ¡é€»è¾‘çš„ä¼˜é›…æ‰§è¡Œè€…
-   **äº‹ä»¶ç›‘å¬**ï¼šçŠ¶æ€å˜æ›´çš„å®æ—¶å¹¿æ’­

#### ğŸ› ï¸ 5åˆ†é’Ÿä¸Šæ‰‹

```java

// ğŸ¯ å®šä¹‰çŠ¶æ€æšä¸¾
public enum OrderState {
    CREATED, PENDING_PAYMENT, PAID, SHIPPED, COMPLETED, CANCELLED
}

// âš¡ é…ç½®çŠ¶æ€æµè½¬
@Configuration
public class OrderStateMachineConfig implements StateMachineConfig {
    @Override
    public Map<String, StateTransition> getTransitions() {
        return Map.of(
            "PAY_SUCCESS", new StateTransition("PENDING_PAYMENT", "PAY_SUCCESS", "PAID"),
            "SHIP", new StateTransition("PAID", "SHIP", "SHIPPED")
        );
    }
}

// ğŸš€ ä½¿ç”¨çŠ¶æ€æœº
@Service
public class OrderService {
    @Autowired private StateMachineFactory stateMachineFactory;
    
    public Order processPayment(Long orderId, PaymentResult payment) {
        StateMachineContext context = new StateMachineContext("ORDER", orderId.toString());
        GenericStateMachine stateMachine = stateMachineFactory.create("ORDER");
        String event = payment.isSuccess() ? "PAY_SUCCESS" : "PAY_FAILED";
        stateMachine.trigger(event, context);
        return orderRepository.findById(orderId).orElseThrow();
    }
}
```

#### ğŸ“ˆ æ€§èƒ½æ•°æ®

-   **è®¢å•åˆ›å»ºåˆ°æ”¯ä»˜å®Œæˆ**ï¼šä»156msä¼˜åŒ–åˆ°62msï¼ˆâ© 60%æ›´å¿«ï¼‰
-   **é«˜å¹¶å‘çŠ¶æ€è½¬æ¢**ï¼šä»280 TPSæå‡åˆ°850 TPSï¼ˆğŸ“ˆ 200%æ›´é«˜ååï¼‰

* * *

### 2. ğŸ”¥ Silky RabbitMQï¼šä¼ä¸šçº§æ¶ˆæ¯é˜Ÿåˆ—è§£å†³æ–¹æ¡ˆ

**å¼€ç®±å³ç”¨ï¼Œä¸æ»‘é›†æˆï¼**

#### âœ¨ æ ¸å¿ƒç‰¹æ€§

-   **æ³¨è§£é©±åŠ¨**ï¼š`@RabbitMessage`Â é›¶ä¾µå…¥å‘é€
-   **å»¶è¿Ÿæ¶ˆæ¯**ï¼šæ¯«ç§’çº§ç²¾åº¦çš„å®šæ—¶æ¶ˆæ¯
-   **å¤šç»´åº¦æŒä¹…åŒ–**ï¼šæ•°æ®åº“ã€Redisã€MongoDBå…¨æ”¯æŒ
-   **æ™ºèƒ½é‡è¯•**ï¼šå¯é…ç½®æ¬¡æ•°ä¸é—´éš”ï¼Œæ”¯æŒæŒ‡æ•°é€€é¿

#### ğŸš€ ä½¿ç”¨ç¤ºä¾‹


``` java

// ğŸ“¤ AOPæ³¨è§£æ–¹å¼ï¼ˆæ¨èï¼‰
@Service
public class OrderService {
    @RabbitMessage(
        exchange = "order.exchange",
        routingKey = "order.create",
        businessType = "ORDER_CREATE",
        sendMode = SendMode.SYNC,
        delay = 30 * 60 * 1000L  // 30åˆ†é’Ÿå»¶è¿Ÿæ¶ˆæ¯
    )
    public OrderResult createOrder(CreateOrderRequest request) {
        // ä¸šåŠ¡é€»è¾‘å¤„ç†
        OrderResult result = orderMapper.insert(request);
        // æ–¹æ³•æ‰§è¡ŒæˆåŠŸåè‡ªåŠ¨å‘é€æ¶ˆæ¯
        return result;
    }
}

// ğŸ“¥ æ¶ˆè´¹ç›‘å¬
@Slf4j
@Component
public class OrderCreateListener extends AbstractRabbitMQListener<TradeOrder> {
    public OrderCreateListener() {
        super("order.create.queue");
    }
    
    @Override
    public void onMessage(TradeOrder message, Channel channel, Message amqpMessage) {
        log.info("æ”¶åˆ°è®¢å•åˆ›å»ºæ¶ˆæ¯: {}", message.getOrderId());
        orderProcessService.processOrder(message);
        // è‡ªåŠ¨å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶
    }
}
```

#### ğŸ”§ é«˜çº§ç‰¹æ€§

``` yaml

spring:
  rabbitmq:
    silky:
      send:
        default-send-mode: SYNC
        enable-retry: true
        max-retry-count: 3
      persistence:
        enabled: true
        type: DATABASE  # æ”¯æŒDATABASE/REDIS/MONGODB
```

* * *

### 3. âš¡ Silky Redisï¼šä¸€ç«™å¼é«˜æ€§èƒ½ç¼“å­˜è§£å†³æ–¹æ¡ˆ

**äº”å¤§æ ¸å¿ƒåŠŸèƒ½ï¼Œå½»åº•å‘Šåˆ«Redisç—›ç‚¹ï¼**

#### ğŸ¯ äº”å¤§æ ¸å¿ƒæ¨¡å—

| åŠŸèƒ½        | å›¾æ ‡ | æè¿°                    |
| --------- | -- | --------------------- |
| **æ™ºèƒ½ç¼“å­˜**  | ğŸ’¾ | FastJson2åºåˆ—åŒ–ï¼Œæ€§èƒ½æå‡35%+ |
| **åˆ†å¸ƒå¼é”**  | ğŸ”’ | äº‹åŠ¡æ„ŸçŸ¥ï¼Œå®Œç¾è§£å†³å¹¶å‘é—®é¢˜         |
| **å”¯ä¸€å•å·**  | ğŸ”¢ | é«˜å¹¶å‘å®‰å…¨çš„åˆ†å¸ƒå¼IDç”Ÿæˆ         |
| **åˆ†å¸ƒå¼é™æµ** | ğŸš¦ | ä¸‰ç§ç®—æ³•åº”å¯¹ä¸åŒåœºæ™¯            |
| **åœ°ç†ä½ç½®**  | ğŸŒ | é«˜æ•ˆçš„åœ°ç†ä½ç½®è®¡ç®—ä¸æœç´¢          |

#### ğŸ› ï¸ å¿«é€Ÿä½¿ç”¨

``` java

// ğŸ’¾ æ™ºèƒ½ç¼“å­˜
@Service
public class ProductService {
    @Autowired private RedisCacheTemplate redisCacheTemplate;
    
    public void cacheProduct(Product product) {
        redisCacheTemplate.setObject("product:" + product.getId(), product, 1, TimeUnit.HOURS);
    }
}

// ğŸ”’ åˆ†å¸ƒå¼é”ï¼ˆäº‹åŠ¡æ„ŸçŸ¥ï¼‰
@RedisLock(key = "'order:' + #orderId", lockType = LockType.REENTRANT, waitTime = 10)
@Transactional
public void processOrder(String orderId) {
    // ä¸šåŠ¡é€»è¾‘ï¼Œé”ä¼šåœ¨äº‹åŠ¡æäº¤åè‡ªåŠ¨é‡Šæ”¾
}

// ğŸ”¢ å”¯ä¸€å•å·ç”Ÿæˆ
@RedisSequence(
    redisKey = "order:number",
    prefix = "ORDER",
    datePattern = "yyyyMMdd",
    sequenceLength = 6
)
public String generateOrderNumber() {
    return null; // ç”±åˆ‡é¢è‡ªåŠ¨ç”Ÿæˆï¼Œå¦‚ï¼šORDER20231130143015000001005
}

// ğŸš¦ åˆ†å¸ƒå¼é™æµ
@RateLimit(
    key = "'api:user:register:' + #request.ip",
    algorithm = RateLimitAlgorithm.TOKEN_BUCKET,
    capacity = 100,
    refillRate = 10
)
public ApiResponse<User> userRegister(UserRegisterRequest request) {
    // ä»¤ç‰Œæ¡¶é™æµï¼Œå¹³æ»‘æ§åˆ¶æµé‡
}
```

* * *

### 4. ğŸƒ Silky MongoDBï¼šé©å‘½æ€§çš„NoSQLæ“ä½œä½“éªŒ

**Lambdaè¡¨è¾¾å¼ + å¤šæ•°æ®æºï¼Œå¼€å‘æ•ˆç‡æš´å¢300%ï¼**

#### âœ¨ é©å‘½æ€§ç‰¹æ€§

-   **Lambdaè¡¨è¾¾å¼**ï¼šç±»å‹å®‰å…¨ï¼Œå‘Šåˆ«å­—æ®µåç¡¬ç¼–ç 
-   **å¤šæ•°æ®æºåˆ‡æ¢**ï¼šä¸€è¡Œæ³¨è§£æå®šæ•°æ®æºåˆ‡æ¢
-   **è¯»å†™åˆ†ç¦»**ï¼šè‡ªåŠ¨è·¯ç”±ï¼Œé›¶é…ç½®ä¸Šæ‰‹
-   **äº‹åŠ¡æ”¯æŒ**ï¼šä¼ä¸šçº§æ•°æ®ä¸€è‡´æ€§ä¿éšœ

#### ğŸš€ ä»£ç å¯¹æ¯”


``` java

// âŒ ä¼ ç»Ÿå†™æ³•ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰
Query query = new Query();
query.addCriteria(Criteria.where("userName").is("å¼ ä¸‰"));
query.addCriteria(Criteria.where("userAge").gt(18));
List<User> users = mongoTemplate.find(query, User.class);

// âœ… Silkyå†™æ³•ï¼ˆç±»å‹å®‰å…¨ï¼ŒIDEæ™ºèƒ½æç¤ºï¼‰
List<User> users = silkyMongoTemplate.list(
    new LambdaQueryWrapper<>(User.class)
        .eq(User::getName, "å¼ ä¸‰")  // IDEè‡ªåŠ¨è¡¥å…¨
        .gt(User::getAge, 18),     // ç¼–è¯‘æœŸæ£€æŸ¥
    User.class
);
```

#### ğŸ”„ å¤šæ•°æ®æºç®¡ç†


``` java

@Service
public class MultiDataSourceService {
    // ğŸ¯ æ³¨è§£åˆ‡æ¢æ•°æ®æº
    @DataSource("user_db")
    public List<User> getUsers() {
        return silkyMongoTemplate.list(User.class);
    }
    
    @DataSource("order_db") 
    public List<Order> getOrders() {
        return silkyMongoTemplate.list(Order.class);
    }
    
    // ğŸš€ è·¨æ•°æ®æºäº‹åŠ¡
    @Transactional
    public void createUserAndOrder(User user, Order order) {
        silkyMongoTemplate.switchDataSource("user_db");
        User savedUser = silkyMongoTemplate.save(user);
        
        silkyMongoTemplate.switchDataSource("order_db");
        order.setUserId(savedUser.getId());
        silkyMongoTemplate.save(order);
        // ğŸ’¡ ä¸¤ä¸ªæ“ä½œåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼
    }
}
```

#### âš¡ æ€§èƒ½ä¼˜åŒ–

-   **æ‰¹é‡æ’å…¥1ä¸‡æ¡**ï¼šä»1250msä¼˜åŒ–åˆ°280msï¼ˆğŸš€ 77%æ€§èƒ½æå‡ï¼‰
-   **å¤æ‚æ¡ä»¶æŸ¥è¯¢**ï¼šä»45msä¼˜åŒ–åˆ°22msï¼ˆğŸš€ 51%æ€§èƒ½æå‡ï¼‰

* * *

### 5. â˜ï¸ Silky OSSï¼šå¤šäº‘ç»Ÿä¸€çš„æ–‡ä»¶å­˜å‚¨è§£å†³æ–¹æ¡ˆ

**æ™ºèƒ½ä¸Šä¼ ï¼Œæ–­ç‚¹ç»­ä¼ ï¼Œè®©æ–‡ä»¶ç®¡ç†å¦‚ä¸èˆ¬é¡ºæ»‘ï¼**

#### âœ¨ æ ¸å¿ƒç‰¹æ€§

-   **å¤šäº‘æ”¯æŒ**ï¼šé˜¿é‡Œäº‘OSSã€åä¸ºäº‘OBSç­‰ï¼ˆå¯æ‰©å±•ï¼‰
-   **æ™ºèƒ½ä¸Šä¼ **ï¼šæ ¹æ®æ–‡ä»¶å¤§å°è‡ªåŠ¨é€‰æ‹©æœ€ä½³ä¸Šä¼ æ–¹å¼
-   **æ–­ç‚¹ç»­ä¼ **ï¼šå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ï¼Œç½‘ç»œæ³¢åŠ¨ä¸å½±å“ä½“éªŒ
-   **è¿›åº¦ç›‘æ§**ï¼šå®æ—¶è·å–ä¸Šä¼ è¿›åº¦ä¿¡æ¯
-   **å®‰å…¨å¯æ§**ï¼šæ”¯æŒåŠ å¯†ä¸Šä¼ å’Œæƒé™æ§åˆ¶

#### ğŸš€ å¿«é€Ÿå¼€å§‹

##### 1ï¸âƒ£ æ·»åŠ ä¾èµ–

``` xml

<dependency>
    <groupId>io.github.yijuanmao</groupId>
    <artifactId>silky-oss-spring-boot-starter</artifactId>
    <version>æœ€æ–°ç‰ˆæœ¬</version>
</dependency>

<!-- æ ¹æ®é…ç½®é€‰æ‹©å¯¹åº”çš„ä¾èµ–åŒ… -->
<!-- é˜¿é‡Œäº‘OSS -->
<dependency>
    <groupId>com.aliyun.oss</groupId>
    <artifactId>aliyun-sdk-oss</artifactId>
    <version>3.18.3</version>
</dependency>

<!-- åä¸ºäº‘OBS -->
<dependency>
    <groupId>com.huaweicloud</groupId>
    <artifactId>esdk-obs-java</artifactId>
    <version>3.25.7</version>
</dependency>
```

##### 2ï¸âƒ£ é…ç½®å‚æ•°


``` yaml

silky:
  oss:
    access-key: ä½ çš„AccessKey
    secret-key: ä½ çš„SecretKey
    bucket: ä½ çš„Bucketåç§°
    multipart-threshold: 134217728 # 128MBï¼Œè¶…è¿‡æ­¤å¤§å°è‡ªåŠ¨åˆ†ç‰‡ä¸Šä¼ 
    multipart-part-size: 33554432 # 32MBï¼Œæ¯ä¸ªåˆ†ç‰‡å¤§å°
    provider: aliyun # å¹³å°ï¼šaliyunã€huawei
    # é˜¿é‡Œäº‘é…ç½®
    aliyun:
      endpoint: é˜¿é‡Œäº‘OSSçš„Endpoint
    # åä¸ºäº‘é…ç½®
    huawei:
      endpoint: åä¸ºäº‘çš„Endpoint
```

##### 3ï¸âƒ£ ä½¿ç”¨ç¤ºä¾‹

``` java

@Service
public class FileUploadService {
    
    @Autowired
    private OssTemplate ossTemplate;
    
    /**
     * æ™ºèƒ½ä¸Šä¼ ï¼ˆæ ¹æ®æ–‡ä»¶å¤§å°è‡ªåŠ¨é€‰æ‹©æœ€ä½³ä¸Šä¼ æ–¹å¼ï¼‰
     */
    public String uploadFile(MultipartFile file) {
        OssUploadParam param = new OssUploadParam();
        param.setObjectKey("uploads/" + System.currentTimeMillis() + "_" + file.getOriginalFilename());
        param.setFile(new File(file.getOriginalFilename()));
        param.setContentType(OssFileTypeEnum.fromFileName(file.getOriginalFilename()).getContentType());
        
        OssUploadResult result = ossTemplate.smartUpload(param);
        return result.getUrl();
    }
    
    /**
     * å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ 
     */
    public String uploadLargeFile(File largeFile) {
        // 1. åˆå§‹åŒ–åˆ†ç‰‡ä¸Šä¼ 
        InitiateMultipartUploadParam initParam = new InitiateMultipartUploadParam();
        initParam.setObjectKey("largefiles/" + largeFile.getName());
        InitiateMultipartResult initResult = ossTemplate.initiateMultipartUpload(initParam);
        
        String uploadId = initResult.getUploadId();
        List<PartETag> partETags = new ArrayList<>();
        
        // 2. åˆ†ç‰‡ä¸Šä¼ 
        long partSize = 32 * 1024 * 1024; // 32MB
        long fileLength = largeFile.length();
        int partCount = (int) (fileLength / partSize);
        if (fileLength % partSize != 0) {
            partCount++;
        }
        
        for (int i = 0; i < partCount; i++) {
            UploadPartParam partParam = new UploadPartParam();
            partParam.setUploadId(uploadId);
            partParam.setPartNumber(i + 1);
            // è®¾ç½®åˆ†ç‰‡æ•°æ®æµ...
            
            UploadPartResult partResult = ossTemplate.uploadPart(partParam);
            partETags.add(new PartETag(i + 1, partResult.getEtag()));
        }
        
        // 3. å®Œæˆåˆ†ç‰‡ä¸Šä¼ 
        CompleteMultipartUploadParam completeParam = new CompleteMultipartUploadParam();
        completeParam.setUploadId(uploadId);
        completeParam.setObjectKey("largefiles/" + largeFile.getName());
        completeParam.setPartEtags(partETags);
        
        CompleteMultipartUploadResult result = ossTemplate.completeMultipartUpload(completeParam);
        return result.getUrl();
    }
    
    /**
     * ç”Ÿæˆé¢„ç­¾åURLï¼ˆç”¨äºä¸´æ—¶è®¿é—®ï¼‰
     */
    public String generatePresignedUrl(String objectKey, int expirationMinutes) {
        GenPreSignedUrlParam param = new GenPreSignedUrlParam();
        param.setObjectKey(objectKey);
        param.setExpirationMinutes(expirationMinutes);
        
        GenPreSignedUrlResult result = ossTemplate.genPreSignedUrl(param);
        return result.getUrl();
    }
}
```

#### ğŸ”§ é«˜çº§åŠŸèƒ½

``` java


// è‡ªå®šä¹‰äº‘æœåŠ¡æä¾›å•†
@Configuration
public class OssConfig {
    @Bean
    public void registerCustomProvider(OssTemplate ossTemplate) {
        // åˆ›å»ºè‡ªå®šä¹‰æä¾›å•†é€‚é…å™¨
        OssProviderAdapter customAdapter = new CustomOssProviderAdapter();
        // æ³¨å†Œåˆ°OSSæ¨¡æ¿
        ossTemplate.registerProvider("custom", customAdapter);
    }
}

// åˆ‡æ¢äº‘æœåŠ¡æä¾›å•†
public class CloudSwitchService {
    @Autowired
    private OssTemplate ossTemplate;
    
    public void switchToHuawei() {
        ossTemplate.switchProvider("huawei");
    }
    
    public void switchToAliyun() {
        ossTemplate.switchProvider("aliyun");
    }
}
```

#### ğŸ“Š åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§        | ä¼ ç»Ÿæ–¹å¼          | Silky OSS  | ä¼˜åŠ¿     |
| --------- | ------------- | ---------- | ------ |
| **å¤šå¹³å°æ”¯æŒ** | éœ€è¦ä¸ºæ¯ä¸ªå¹³å°ç¼–å†™ä¸åŒä»£ç  | ç»Ÿä¸€APIï¼Œä¸€é”®åˆ‡æ¢ | é™ä½ç»´æŠ¤æˆæœ¬ |
| **å¤§æ–‡ä»¶ä¸Šä¼ ** | å®¹æ˜“å¤±è´¥ï¼Œæ— æ–­ç‚¹ç»­ä¼     | è‡ªåŠ¨åˆ†ç‰‡ï¼Œæ–­ç‚¹ç»­ä¼   | ç¨³å®šå¯é    |
| **è¿›åº¦ç›‘æ§**  | éœ€è¦æ‰‹åŠ¨å®ç°        | å†…ç½®è¿›åº¦å›è°ƒæœºåˆ¶   | ç”¨æˆ·ä½“éªŒå¥½  |
| **å®‰å…¨æ€§**   | éœ€è¦è‡ªè¡Œå¤„ç†åŠ å¯†å’Œæƒé™   | å†…ç½®å®‰å…¨æœºåˆ¶     | å¼€ç®±å³ç”¨   |

* * *

## ğŸª ç”Ÿæ€é›†æˆï¼š1+1>2çš„ååŒæ•ˆåº”

### ğŸ—„ï¸ çŠ¶æ€æœº + MongoDB + OSSï¼šå®Œæ•´çš„çŠ¶æ€å†å²ä¸å¤‡ä»½


``` java

@Component
public class StateMachinePersistenceService {
    @Autowired private MongoTemplate mongoTemplate;
    @Autowired private OssTemplate ossTemplate;
    
    /**
     * ä¿å­˜çŠ¶æ€å†å²åˆ°MongoDBï¼Œé‡è¦å¿«ç…§å¤‡ä»½åˆ°OSS
     */
    public void persistState(StateMachineContext context, String fromState, String toState) {
        // 1. ä¿å­˜åˆ°MongoDB
        StateHistory history = StateHistory.builder()
            .machineType(context.getMachineType())
            .businessId(context.getBusinessId())
            .fromState(fromState)
            .toState(toState)
            .timestamp(LocalDateTime.now())
            .extendedData(context.getVariables())
            .build();
        mongoTemplate.save(history);
        
        // 2. é‡è¦çŠ¶æ€å¿«ç…§å¤‡ä»½åˆ°OSS
        if (isImportantState(toState)) {
            String snapshotJson = JSON.toJSONString(context.getVariables());
            String backupKey = String.format("state-backup/%s/%s-%d.json",
                context.getMachineType(),
                context.getBusinessId(),
                System.currentTimeMillis());
            
            OssUploadParam param = new OssUploadParam();
            param.setObjectKey(backupKey);
            param.setStream(new ByteArrayInputStream(snapshotJson.getBytes()));
            param.setContentType("application/json");
            
            ossTemplate.smartUpload(param);
        }
    }
}
```

### ğŸ”„ RabbitMQ + Redis + OSSï¼šé«˜å¯é çš„æ¶ˆæ¯å¤„ç†ä¸æ–‡ä»¶å­˜å‚¨


``` java

@Component  
public class FileProcessingPipeline {
    @Autowired private RabbitSendTemplate rabbitSendTemplate;
    @Autowired private RedisLockTemplate redisLockTemplate;
    @Autowired private OssTemplate ossTemplate;
    
    /**
     * å¤„ç†æ–‡ä»¶ä¸Šä¼ å¹¶å‘é€æ¶ˆæ¯é€šçŸ¥
     */
    public void processFileUpload(FileUploadEvent event) {
        // 1. ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢é‡å¤å¤„ç†
        redisLockTemplate.lock("file:process:" + event.getFileId(), 1, 30, TimeUnit.SECONDS, true, () -> {
            // 2. ä¸Šä¼ æ–‡ä»¶åˆ°OSS
            OssUploadParam uploadParam = new OssUploadParam();
            uploadParam.setObjectKey("uploads/" + event.getFileId() + "/" + event.getFileName());
            uploadParam.setFile(event.getFile());
            
            OssUploadResult uploadResult = ossTemplate.smartUpload(uploadParam);
            
            // 3. å‘é€æ¶ˆæ¯é€šçŸ¥ç›¸å…³æœåŠ¡
            FileProcessedMessage message = new FileProcessedMessage();
            message.setFileId(event.getFileId());
            message.setFileUrl(uploadResult.getUrl());
            message.setFileSize(event.getFileSize());
            
            rabbitSendTemplate.send(
                "file.exchange",
                "file.processed",
                message,
                "FILE_PROCESSED",
                "æ–‡ä»¶å¤„ç†å®Œæˆæ¶ˆæ¯"
            );
            
            return uploadResult;
        });
    }
}
```

* * *

## ğŸ“¦ å¿«é€Ÿå¼€å§‹ï¼š5åˆ†é’Ÿé›†æˆæ•´ä¸ªç”Ÿæ€

### 1ï¸âƒ£ æ·»åŠ ä¾èµ–


``` xml

<!-- æ ¸å¿ƒç”Ÿæ€ä¾èµ– -->
<dependencies>
    <!-- çŠ¶æ€ç®¡ç† -->
    <dependency>
        <groupId>io.github.yijuanmao</groupId>
        <artifactId>silky-statemachine-spring-boot-starter</artifactId>
        <version>æœ€æ–°ç‰ˆæœ¬</version>
    </dependency>
    
    <!-- æ¶ˆæ¯é˜Ÿåˆ— -->
    <dependency>
        <groupId>io.github.yijuanmao</groupId>
        <artifactId>silky-rabbitmq-spring-boot-starter</artifactId>
        <version>æœ€æ–°ç‰ˆæœ¬</version>
    </dependency>
    
    <!-- Rediså…¨èƒ½ç»„ä»¶ -->
    <dependency>
        <groupId>io.github.yijuanmao</groupId>
        <artifactId>silky-redis-spring-boot-starter</artifactId>
        <version>æœ€æ–°ç‰ˆæœ¬</version>
    </dependency>
    
    <!-- MongoDBå¢å¼º -->
    <dependency>
        <groupId>io.github.yijuanmao</groupId>
        <artifactId>silky-mongodb-spring-boot-starter</artifactId>
        <version>æœ€æ–°ç‰ˆæœ¬</version>
    </dependency>
    
    <!-- OSSäº‘å­˜å‚¨ -->
    <dependency>
        <groupId>io.github.yijuanmao</groupId>
        <artifactId>silky-oss-spring-boot-starter</artifactId>
        <version>æœ€æ–°ç‰ˆæœ¬</version>
    </dependency>
</dependencies>
```

### 2ï¸âƒ£ å¯ç”¨ç»„ä»¶


``` java

@SpringBootApplication
@ComponentScan({"com.silky.**"})  // ğŸ¯ ä¸€è¡Œæ³¨è§£å¯ç”¨æ•´ä¸ªç”Ÿæ€
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

### 3ï¸âƒ£ æç®€é…ç½®

``` yaml

# ç»Ÿä¸€é…ç½®å…¥å£
silky:
  enabled: true
  
  # MongoDBé…ç½®
  mongodb:
    datasource:
      master:
        uri: mongodb://localhost:27017/main_db
      slave:
        uri: mongodb://localhost:27017/read_db
  
  # Redisé…ç½®ï¼ˆè‡ªåŠ¨å¯ç”¨æ‰€æœ‰åŠŸèƒ½ï¼‰
  redis:
    host: localhost
    port: 6379
  
  # RabbitMQé…ç½®
  rabbitmq:
    host: localhost
    port: 5672
    silky:
      send:
        default-send-mode: SYNC
      persistence:
        enabled: true
  
  # OSSäº‘å­˜å‚¨é…ç½®
  oss:
    provider: aliyun
    access-key: ${OSS_ACCESS_KEY}
    secret-key: ${OSS_SECRET_KEY}
    bucket: ${OSS_BUCKET}
    aliyun:
      endpoint: ${OSS_ENDPOINT}
```

### 4ï¸âƒ£ åˆ›å»ºç¤ºä¾‹åº”ç”¨


``` java


@RestController
@RequestMapping("/api")
public class DemoController {
    
    @Autowired private StateMachineFactory stateMachineFactory;
    @Autowired private RabbitSendTemplate rabbitSendTemplate;
    @Autowired private RedisCacheTemplate redisCacheTemplate;
    @Autowired private SilkyMongoTemplate silkyMongoTemplate;
    @Autowired private OssTemplate ossTemplate;
    
    /**
     * å®Œæ•´çš„ä¸šåŠ¡å¤„ç†ç¤ºä¾‹
     */
    @PostMapping("/orders")
    @RabbitMessage(
        exchange = "order.exchange",
        routingKey = "order.create",
        businessType = "ORDER_CREATE"
    )
    @RedisLock(key = "'order:create:' + #request.userId", waitTime = 5)
    public Order createOrder(@RequestBody CreateOrderRequest request) {
        // 1. é™æµæ£€æŸ¥
        if (isRateLimited(request.getUserId())) {
            throw new RateLimitException("è¯·æ±‚è¿‡äºé¢‘ç¹");
        }
        
        // 2. ä¿å­˜è®¢å•åˆ°MongoDB
        Order order = new Order();
        order.setUserId(request.getUserId());
        order.setAmount(request.getAmount());
        order.setStatus("CREATED");
        
        Order savedOrder = silkyMongoTemplate.save(order);
        
        // 3. ç¼“å­˜è®¢å•ä¿¡æ¯
        redisCacheTemplate.setObject(
            "order:" + savedOrder.getId(),
            savedOrder,
            30,
            TimeUnit.MINUTES
        );
        
        // 4. ä¸Šä¼ è®¢å•é™„ä»¶åˆ°OSS
        if (request.getAttachment() != null) {
            OssUploadParam param = new OssUploadParam();
            param.setObjectKey("orders/" + savedOrder.getId() + "/attachment");
            param.setStream(request.getAttachment().getInputStream());
            ossTemplate.smartUpload(param);
        }
        
        // 5. è§¦å‘çŠ¶æ€æœºæµè½¬
        StateMachineContext context = new StateMachineContext("ORDER", savedOrder.getId().toString());
        context.setVariable("order", savedOrder);
        GenericStateMachine stateMachine = stateMachineFactory.create("ORDER");
        stateMachine.trigger("CREATE", context);
        
        return savedOrder;
    }
    
    private boolean isRateLimited(String userId) {
        // ä½¿ç”¨Redisé™æµæ£€æŸ¥
        String key = "rate:order:create:" + userId;
        Long count = redisCacheTemplate.increment(key, 1);
        if (count == 1) {
            redisCacheTemplate.expire(key, 60, TimeUnit.SECONDS);
        }
        return count > 10; // æ¯åˆ†é’Ÿæœ€å¤š10æ¬¡
    }
}
```

* * *

## ğŸ† ç”Ÿæ€ä»·å€¼ï¼šä¸ºä»€ä¹ˆé€‰æ‹©Silkyï¼Ÿ

### ğŸ¯ æŠ€æœ¯ä»·å€¼

1.  **å®Œæ•´ç”Ÿæ€**ï¼šè¦†ç›–å¾®æœåŠ¡å¼€å‘å…¨é“¾è·¯ï¼Œä»æ•°æ®å­˜å‚¨åˆ°æ–‡ä»¶ç®¡ç†
1.  **æè‡´æ€§èƒ½**ï¼šæ¯ä¸ªç»„ä»¶éƒ½ç»è¿‡ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œæ€§èƒ½å“è¶Š
1.  **æ— ç¼é›†æˆ**ï¼šç»„ä»¶é—´å¤©ç„¶åä½œï¼Œ1+1>2çš„ååŒæ•ˆåº”
1.  **ä¼ä¸šçº§å¯é **ï¼šäº‹åŠ¡æ”¯æŒã€ç›‘æ§å‘Šè­¦ã€æ•…éšœæ¢å¤ä¸€åº”ä¿±å…¨

### ğŸ’° å•†ä¸šä»·å€¼

1.  **é™ä½æ€»æ‹¥æœ‰æˆæœ¬**ï¼šç»Ÿä¸€æŠ€æœ¯æ ˆï¼Œå‡å°‘å­¦ä¹ å’Œç»´æŠ¤æˆæœ¬
1.  **åŠ é€Ÿäº§å“ä¸Šå¸‚**ï¼šå¼€ç®±å³ç”¨ï¼Œèšç„¦ä¸šåŠ¡åˆ›æ–°
1.  **æå‡ç³»ç»Ÿç¨³å®šæ€§**ï¼šç»è¿‡éªŒè¯çš„ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆ
1.  **æœªæ¥å¯æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼ŒæŒ‰éœ€å¼•å…¥ç»„ä»¶

### ğŸ”„ å…¸å‹åº”ç”¨åœºæ™¯

-   **ç”µå•†ç³»ç»Ÿ**ï¼šè®¢å•çŠ¶æ€æœº + åº“å­˜ç¼“å­˜ + æ”¯ä»˜æ¶ˆæ¯é˜Ÿåˆ— + å•†å“å›¾ç‰‡OSSå­˜å‚¨
-   **å†…å®¹å¹³å°**ï¼šMongoDBå†…å®¹å­˜å‚¨ + Redisçƒ­ç‚¹ç¼“å­˜ + OSSåª’ä½“æ–‡ä»¶å­˜å‚¨
-   **ç‰©è”ç½‘å¹³å°**ï¼šè®¾å¤‡çŠ¶æ€æœº + æ¶ˆæ¯é˜Ÿåˆ— + Rediså®æ—¶ç¼“å­˜ + OSSæ•°æ®å¤‡ä»½
-   **é‡‘èç³»ç»Ÿ**ï¼šåˆ†å¸ƒå¼é” + äº¤æ˜“çŠ¶æ€æœº + Redisé™æµ + å®¡è®¡æ—¥å¿—OSSå­˜å‚¨

* * *

## ğŸ“š å­¦ä¹ èµ„æº

-   **ğŸŒ å®˜æ–¹ç½‘ç«™**ï¼š[https://silky-ecosystem.github.io](https://github.com/yijuanmao/silky-starter)
-   **ğŸ“– å®Œæ•´æ–‡æ¡£**ï¼š[GitHub Wiki](https://github.com/yijuanmao/silky-starter/wiki)
-   **ğŸ’» ç¤ºä¾‹é¡¹ç›®**ï¼š[silky-demo](https://github.com/yijuanmao/silky-starter/tree/master/silky-starter-test)

[//]: # (-   **ğŸ¬ è§†é¢‘æ•™ç¨‹**ï¼š[Bç«™ä¸“æ ]&#40;https://space.bilibili.com/your-channel&#41;)

## ğŸ¤ åŠ å…¥æˆ‘ä»¬

Silky ç”Ÿæ€ç”±å¼€å‘è€…å…±å»ºï¼Œä¸ºå¼€å‘è€…æœåŠ¡ï¼æˆ‘ä»¬æ¬¢è¿ï¼š

-   ğŸÂ **æäº¤ Issue**ï¼š[æŠ¥å‘Šé—®é¢˜æˆ–å»ºè®®](https://github.com/yijuanmao/silky-starter/issues)
-   ğŸ”§Â **æäº¤ PR**ï¼šæ¬¢è¿ä»£ç è´¡çŒ®ï¼Œå…±å»ºæ›´å¥½ç”¨çš„ç»„ä»¶
-   ğŸ“šÂ **å®Œå–„æ–‡æ¡£**ï¼šå¸®åŠ©æ›´å¤šäººä¸Šæ‰‹ä½¿ç”¨
-   ğŸ’¬Â **æŠ€æœ¯äº¤æµ**ï¼šåŠ å…¥æˆ‘ä»¬çš„å¼€å‘è€…ç¤¾åŒº
-   â­Â **Star æ”¯æŒ**ï¼šä½ çš„è®¤å¯æ˜¯æˆ‘ä»¬æŒç»­æ›´æ–°çš„åŠ¨åŠ›

## ğŸ‰ ç«‹å³å¼€å§‹

**ä¸è¦å†æµªè´¹æ—¶é—´åœ¨æŠ€æœ¯é€‰å‹å’Œç»„ä»¶é›†æˆä¸Šäº†ï¼**  
é€‰æ‹© Silky ç”Ÿæ€ï¼Œä¸€æ¬¡æ€§è·å¾—ä¼ä¸šçº§çš„æŠ€æœ¯åŸºç¡€è®¾æ–½ï¼Œè®©å›¢é˜Ÿä¸“æ³¨äºåˆ›é€ ä¸šåŠ¡ä»·å€¼ï¼


``` bash

# å…‹éš†ç¤ºä¾‹é¡¹ç›®ï¼Œç«‹å³ä½“éªŒ
git clone https://github.com/yijuanmao/silky-starter.git
cd silky-starter/silky-starter-test
mvn spring-boot:run
```

**åŠ å…¥æ•°åƒå®¶ä¼ä¸šçš„é€‰æ‹©ï¼Œè®© Silky ç”Ÿæ€ä¸ºä½ çš„ä¸šåŠ¡æ³¨å…¥æ–°çš„æ´»åŠ›ï¼**

* * *

### ğŸ‘¥ åŠ å…¥ç¤¾åŒº

ğŸ“¢ **å…³æ³¨SilkyStarter**å…¬ä¼—å·è·å–æœ€æ–°æºç å’ŒæŠ€æœ¯åŠ¨æ€ï¼  
ğŸ’¬ **åŠ å…¥silky-starteræŠ€æœ¯äº¤æµç¾¤**ï¼Œä¸ä¼—å¤šå¼€å‘è€…ä¸€èµ·æ¢è®¨æŠ€æœ¯é—®é¢˜ï¼š  
æ·»åŠ å¾®ä¿¡ `824414828` æˆ–æ‰«æå…¬ä¼—å·äºŒç»´ç ï¼Œå¤‡æ³¨"æŠ€æœ¯äº¤æµ"é‚€è¯·è¿›ç¾¤

â­ **å¦‚æœè¿™ä¸ªé¡¹ç›®å¸®åŠ©äº†ä½ ï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ªStarï¼**

**å¦‚æœè¿™è®©ä½ æ„ŸåŒèº«å—ï¼Œé‚£ä¹ˆä»Šå¤©å°±æ˜¯ä½ çš„å¹¸è¿æ—¥ï¼**

* * *

## ğŸ™ æ„Ÿè°¢æ”¯æŒ

**å¦‚æœè§‰å¾— Silky ç”Ÿæ€å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ª â­ Star æ”¯æŒï¼**  
**åˆ†äº«ç»™æ›´å¤šå¼€å‘è€…ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ„å»ºæ›´å¥½çš„å¼€å‘ç”Ÿæ€ï¼**

<div align="center">

### ğŸ’³ æ”¯æŒæˆ‘ä»¬

å¦‚æœä½ è§‰å¾—æˆ‘ä»¬çš„å·¥ä½œå¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¯ä»¥æèµ è¯·ä½œè€…å–æ¯å’–å•¡~ï¼Œåœ¨æ­¤è¡¨ç¤ºæ„Ÿè°¢ï¼

<img src="https://petsgo.oss-cn-shenzhen.aliyuncs.com/prod/wx.jpg" height="300px" alt="å¾®ä¿¡"> <img src="https://petsgo.oss-cn-shenzhen.aliyuncs.com/prod/alipay.jpg" height="300px" alt="æ”¯ä»˜å®">

æˆ–è€…ç‚¹å‡»ä»¥ä¸‹é“¾æ¥ï¼Œå°†é¡µé¢æ‹‰åˆ°æœ€ä¸‹æ–¹ç‚¹å‡»"æèµ "å³å¯  
[Giteeä¸Šæèµ ](https://gitee.com/zeng_er/silky-starter)

* * *

[//]: # (**ğŸ“§ æŠ€æœ¯å’¨è¯¢ï¼š824414828@qq.com**  )

[//]: # (**ğŸŒ å…³æ³¨æˆ‘ä»¬ï¼š[@SilkyEcosystem]&#40;https://twitter.com/SilkyEcosystem&#41;**)

*æœ¬æ–‡ç”± Silky ç”Ÿæ€ç³»ç»Ÿå›¢é˜Ÿå€¾æƒ…å¥‰çŒ®*